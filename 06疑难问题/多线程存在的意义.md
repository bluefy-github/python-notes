# 多线程存在的意义



**Python 因为GIL的原因，多线程性能鸡肋，也有了协程可以替代，那么多线程是否还有存在的意义？**



多线程肯定是有用的。

python的GIL会在遇到IO的情况下会主动切换线程，而协程处理IO时是显式让出CPU。但是多线程切换的代价要大于协程切换，一般协程处理IO密集型要比多线程好。

但是在运算密集型的情况下，由于python原生的计算能力比较弱，使用协程可能会在某一个协程上计算花费大量的时间，从而让不出cpu导致其他的协程阻塞。而多线程会基于时间片均衡的切换。



个人认为python的多线程是有必要的。

## **并发**

并发具体是对指线程（或者协程）的调度。

- python的线程间切换主要是语言层面上的（GIL）。早期的线程间切换主要考量线程已经运行的字节码个数（达到一个阈值后，释放GIL，把控制权交给其他线程），后面改成了考量线程运行的时长（类似时间片）。[[1\]](#ref_1)
- python的协程间切换主要是应用层面上的。

调度的好坏是多维度的，不仅取决于对公共资源的控制权的精确性，也取决于公平性。

- 对于io阻塞的操作，协程相较于线程，能更精确的获取（或者释放）对资源的控制权。这是因为用户层相较于语言层，用户层能更好的感知特定操作的时机。
- 对于非io阻塞的操作，线程相较于协程，能更公平的分配对资源的控制权。这是因为语言层相较于用户层，语言层能更好的感知到多个线程的运行状态，并在掌握更多信息的前提下（线程运行的字节码和时长），进行更加合理的GIL的获取和释放。

## **并行**

虽然在python层面上，有GIL的限制，但是当python调用C扩展的时候，可以在C扩展中把GIL释放掉，从而达到使用多线程并行的目的。[[2\]](#ref_2)

当下许多的机器学习，深度学习等高性能计算框架，都会在调用C扩展的时候，释放掉GIL。[[3\]](#ref_3)[[4\]](#ref_4)

## 参考

1. [^](#ref_1_0)http://www.dabeaz.com/GIL/
2. [^](#ref_2_0)https://docs.python.org/2/c-api/init.html#releasing-the-gil-from-extension-code
3. [^](#ref_3_0)https://scipy-cookbook.readthedocs.io/items/ParallelProgramming.html#Write-multithreaded-or-multiprocess-code
4. [^](#ref_4_0)https://scipy-cookbook.readthedocs.io/items/Multithreading.html